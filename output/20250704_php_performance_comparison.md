---
marp: true
theme: custom
---

## PHP実行環境パフォーマンス比較

各PHP実行環境の性能比較検証

---

## 共通環境情報

### アプリケーション基盤
- **PHP**: 8.3.20
- **データベース**: MySQL 8.0
- **コンテナ**: Docker + Docker Compose
- **監視**: OpenTelemetry (Jaeger)

---

## 異なる構成部分

### NTS（シングルスレッド）構成
- フレームワーク　Laravel 12
#### 対象実行環境
- Apache + mod_php 
- Nginx + php-fpm 

### ZTS（マルチスレッド）構成
- フレームワーク Laravel Octane
#### 対象実行環境
- Swoole + Nginx (Laravel Octane)
- FrankenPHP (Laravel Octane)

---

## 計測項目

- CPU使用率
- メモリ使用量
- PHPプロセス数
- スループット
- レスポンスタイム

---

## 比較検証のポイント

1. **レスポンス時間**: 同一負荷での応答速度比較
2. **スループット**: 単位時間あたりの処理能力
3. **メモリ使用量**: 各構成でのメモリ効率
4. **CPU使用率**: 処理負荷によるCPU消費
5. **同時接続数**: 最大同時接続処理能力
6. **エラー率**: 高負荷時のエラー発生率

---

## 計測ツール

### メインツール
- **OpenTelemetry**: アプリケーション監視
- **k6**: 負荷テスト

### OpenTelemetryを選んだ理由
- ZTS環境に対応したプロファイリングツールが少ない
- 詳細: https://zenn.dev/booost/articles/a691d0fe7aeae6

---

## 計測しない項目

**ブラウザレンダリング**
- PHPはWebAPIサーバーとして振る舞うことが多いため

---

## テストシナリオ

**記事投稿 + 記事取得**
- 実際のWebアプリケーションを想定
- CRUD操作の性能を検証

---

## データベース設計

**ER図を挿入**
- 記事テーブル
- ユーザーテーブル
- 関連性を含む設計


---

# PHP実行環境パフォーマンス比較

4つの実行環境でパフォーマンス測定を実施

---

## リソース使用量比較

CPU使用率とメモリ使用量の比較

| 環境 | 平均CPU使用率 | 平均メモリ使用量 | CPU効率 | メモリ効率 |
| --- | --- | --- | --- | --- |
| Apache+PHP | 35.77% | 360.08MiB | 要改善 | 普通 |
| Nginx+PHP | 34.32% | **88.75MiB** | 普通 | **最優秀** |
| **Swoole** | **32.03%** | 962.9MiB | **良好** | 要注意 |
| **FrankenPHP** | **20.47%** | 288.4MiB | **最優秀** | 良好 |

---

## PHP実行環境比較結果

| 環境 | P95レスポンス | P90レスポンス | スループット |
| --- | --- | --- | --- |
| Apache+PHP | 36.91ms | 27.99ms | 28.49 RPS |
| Nginx+PHP | 33.77ms | 25.54ms | 28.06 RPS |
| Swoole | 27.15ms | 20.51ms | 28.58 RPS |
| **FrankenPHP** | **25.82ms** | **19.51ms** | **28.65 RPS** |

<!-- FrankenPHPが最高のレスポンス性能、Nginx+PHPが最少メモリ使用量 -->

---

## レスポンス時間詳細比較

各処理別のレスポンス時間（P90）

| 環境 | POST処理（記事作成） | GET処理（記事取得） |
| --- | --- | --- |
| Apache+PHP | 49.61ms | 22.45ms |
| Nginx+PHP | 50.53ms | 20.69ms |
| **Swoole** | **45.64ms** | **16.38ms** |
| **FrankenPHP** | **45.86ms** | **15.48ms** |

<!-- FrankenPHP、Swooleが高速。従来環境より30-40%高速 -->

---

意外と差がないように見えます...

しかし、ここで影の立役者
OPcacheの登場


---

## レスポンスタイム比較

同じ環境でもこれだけの違いが
| 項目 | Memcache無し | Memcache有り | 改善率 |
| --- | --- | --- | --- |
| **平均使用CPU** | 290% | 48% | **83%削減** |
| **平均使用メモリ** | 2.175 **GiB** | 462.1 **MiB** | **79%削減** |
| **平均レスポンス** | 90.31ms | 18.46ms | **80%改善** |
| **P90レスポンス** | 119.35ms | 27.99ms | **77%改善** |
| **P95レスポンス** | 130.59ms | 36.91ms | **72%改善** |


---

## Memcacheの導入により大幅な性能改善

こんな簡単な設定でも効果<span style="font-size: 2em;">大</span>
```
- opcache.enable=1  // 有効にする
- opcache.enable_cli=1 // cliモードでも有効にする
- opcache.memory_consumption=128 // キャッシュサイズの指定
```
WebサーバーやDBのチューニングも重要だけれど
PHPのチューニングも忘れずに！